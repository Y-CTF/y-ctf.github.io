<!doctype html><html lang=en><head><meta charset=utf-8><title> OceanLocust</title><meta content="width=device-width,initial-scale=1.0" name=viewport><link href=https://yctf.ch/css/main.css rel=stylesheet><link as=font crossorigin href=https://yctf.ch/fonts/JetBrainsMono-VariableFont_wght.ttf rel=preload type=font/ttf><link href=https://yctf.ch/rss.xml rel=alternate title=RSS type=application/rss+xml><link href=https://yctf.ch/atom.xml rel=alternate title=RSS type=application/atom+xml><script crossorigin src=https://cdn.jsdelivr.net/npm/@twemoji/api@latest/dist/twemoji.min.js></script><script crossorigin src=https://cdn.jsdelivr.net/npm/fuse.js@7.1.0/dist/fuse.basic.min.js></script><script defer src=https://yctf.ch/js/main.js></script><script defer src=https://yctf.ch/search_index.en.js></script><body class=min-h-[100svh]><div class="w-[50svw] md:w-96 bg-popover absolute left-1/2 top-1/3 transform -translate-x-1/2 -translate-y-1/2 hidden shadow-lg" id=goto-popup><input class="w-full h-8 lg:h-12 px-2 py-1 lg:px-4 lg:py-2" id=goto-input placeholder=Search><div class="w-full h-0.5 bg-muted"></div><div class="w-full max-h-96 overflow-y-auto flex flex-col" id=goto-results></div></div><a class="top-0 left-0 fixed z-10" href=https://yctf.ch> <div class="h-18 md:h-26 lg:h-32 p-2 md:p-4"><div class="w-full h-full flex items-center justify-center"><div class="w-full h-full [&>svg]:w-full [&>svg]:h-full [&>svg]:object-contain invert-colors select-none"><svg viewbox="0 0 300 300" fill=none xmlns=http://www.w3.org/2000/svg><g class=text-container><text style="text-transform:none;letter-spacing:normal;white-space:pre;fill:#e63e3d;fill-opacity:1;direction:ltr;font-family:JetBrains Mono;font-size:129px;font-style:normal;font-weight:800;text-decoration:none" class=fills dominant-baseline=ideographic lengthadjust=spacingAndGlyphs textlength=77.406 x=49.297 y=171.602>Y</text></g><g class=text-container><text style="text-transform:none;letter-spacing:normal;white-space:pre;fill:#e63e3d;fill-opacity:1;direction:ltr;font-family:JetBrains Mono;font-size:129px;font-style:normal;font-weight:800;text-decoration:none" class=fills dominant-baseline=ideographic lengthadjust=spacingAndGlyphs textlength=77.406 x=173.297 y=171.602>C</text></g><g class=text-container><text style="text-transform:none;letter-spacing:normal;white-space:pre;fill:#e63e3d;fill-opacity:1;direction:ltr;font-family:JetBrains Mono;font-size:129px;font-style:normal;font-weight:800;text-decoration:none" class=fills dominant-baseline=ideographic lengthadjust=spacingAndGlyphs textlength=77.406 x=49.297 y=297.602>T</text></g><g class=text-container><text style="text-transform:none;letter-spacing:normal;white-space:pre;fill:#e63e3d;fill-opacity:1;direction:ltr;font-family:JetBrains Mono;font-size:129px;font-style:normal;font-weight:800;text-decoration:none" class=fills dominant-baseline=ideographic lengthadjust=spacingAndGlyphs textlength=77.406 x=173.297 y=297.602>F</text></g></svg></div></div></div> </a><div class="text-secondary-foreground mx-6 md:py-2 py-1 font-black text-lg lg:text-xl top-0 right-0 fixed w-18 md:w-26 h-18 md:h-26 lg:h-32 p-2 md:p-4 text-center flex items-center justify-center z-10"></div><main id=scroll-element><div class="mt-24 mx-4 mb-24 sm:mx-0"><article class="prose dark:prose-invert mx-auto lg:prose-lg"><h1>OceanLocust <span class="text-muted-foreground text-xl">by mango</span></h1><div class="flex flex-row gap-4 items-center"><span><strong>2024-09-30</strong></span><span class=text-muted-foreground>(4 min. read)</span> - <span class="flex flex-row gap-2"> <a class="bg-accent text-accent-foreground px-2 py-1 rounded-md text-sm w-fit font-bold no-underline" href=/categories/reverse> reverse </a> </span><div class=flex-grow></div></div><h2 id=description>Description</h2><p>Wow-ee zow-ee!! Some advanced persistent threats have been doing some tricks with hiding payloads in image files!<p>We thought we would try our hand at it too.<p>NOTE: this challenge includes a debug build of the binary used to craft the image, as well as a release build... so you may choose to go an easier route or a harder route ;)<hr><p>We are handed a 7-zip archive that contains 2 executables and one <code>png</code> image:<pre class=z-code><code><span class="z-text z-plain">$ ll ocean_locust/Chal/
</span><span class="z-text z-plain">.rw-r--r--@ 6.9k acm  4 oct 09:48 inconspicuous.png
</span><span class="z-text z-plain">.rw-r--r--@ 477k acm  1 oct 12:25 png-challenge-debug.exe
</span><span class="z-text z-plain">.rw-r--r--@ 187k acm  1 oct 12:19 png-challenge.exe
</span></code></pre><p>Dynamic analysis reveals that some extra content passed to the program through command-line argument is added to the header and the footer of the PNG file that is fed to the program. We ran the program with the <code>20 * A</code>, <code>20 * B</code> and <code>10 * A + 10 * B</code> payloads to get some data. For instance, 20 B's gives us:<pre class=z-code><code><span class="z-text z-plain">02 62 69 54 62 20 2b 56 d8 40 97 
</span><span class="z-text z-plain">02 62 69 54 63 20 2b 57 1a 2a a0 
</span><span class="z-text z-plain">02 62 69 54 65 20 2b 53 97 56 12 
</span><span class="z-text z-plain">02 62 69 54 69 20 2b 5a 8d af 76 
</span><span class="z-text z-plain">02 62 69 54 64 20 2b 52 55 3c 25
</span><span class="z-text z-plain">02 62 69 54 66 20 2b 51 d1 e8 4b 
</span><span class="z-text z-plain">02 62 69 54 61 20 2b 54 9e fe ce 
</span><span class="z-text z-plain">02 62 69 54 68 20 2b 5b 4f c5 41 
</span><span class="z-text z-plain">02 62 69 54 6a 20 2b 58 cb 11 2f 
</span><span class="z-text z-plain">02 62 69 54 67 20 2b 50 13 82 7c 
</span></code></pre><p>Running the program with different images and identical payloads gives us near-identical results. Running the program multiple times on the same data also gives the same output. We hence guess that there is a clearly defined, 1-to-1 encoding that takes places within the binary. Another neat detail is that the number of lines times the first byte of the line (here <code>02</code>) gives us the length of the string.<p>Through sheer sweat observation, we finally get the hinsight that data is always encoded in the file using a similar pattern that uses the same <code>62 69 54</code> bytes (<code>biT</code> in ascii) near the start of each "sentence". We use this information to carve out the enciphered flag from the <code>inconspicuous.png</code> file.<ul><li><p>Header chunk:</p> <pre class=z-code><code><span class="z-text z-plain">05 62 69 54 68 06 59 29 C2 C8 0A AF 71 26 
</span><span class="z-text z-plain">05 62 69 54 61 04 05 35 06 19 9D C5 69 88 
</span><span class="z-text z-plain">05 62 69 54 62 04 0C 37 5A 55 0C B9 9F 21 
</span><span class="z-text z-plain">05 62 69 54 64 5A 0C 37 5C 06 F9 FB AA 5E
</span><span class="z-text z-plain">05 62 69 54 65 54 5C 36 5D 00 B7 20 36 7B 
</span><span class="z-text z-plain">05 62 69 54 63 01 5F 6D 53 00 7D 55 D6 EC 
</span><span class="z-text z-plain">05 62 69 54 66 00 58 64 03 07 A6 21 A5 2E
</span></code></pre><li><p>Footer chunk:</p> <pre class=z-code><code><span class="z-text z-plain">05 62 69 54 67 55 0B 36 51 57 C8 E8 02 80
</span><span class="z-text z-plain">05 62 69 54 68 06 59 29 C2 C8 0A AF 71 26
</span><span class="z-text z-plain">05 62 69 54 61 04 05 35 06 19 9D C5 69 88 
</span><span class="z-text z-plain">05 62 69 54 62 04 0C 37 5A 55 0C B9 9F 21 
</span><span class="z-text z-plain">05 62 69 54 65 54 5C 36 5D 00 B7 20 36 7B 
</span><span class="z-text z-plain">05 62 69 54 63 01 5F 6D 53 00 7D 55 D6 EC 
</span><span class="z-text z-plain">05 62 69 54 66 00 58 64 03 07 A6 21 A5 2E 
</span><span class="z-text z-plain">05 62 69 54 67 55 0B 36 51 57 C8 E8 02 80 
</span></code></pre></ul><p>We've also discovered that the program sometimes pads the header and footer with repeated words from the flag. The 5th column of numbers is also quite... inconspicuous as it presents a neat pattern of incrementing integers. Once filtered and reordered, we get the following:<pre class=z-code><code><span class="z-text z-plain">05 62 69 54     61     04 05 35 06 19     9D C5 69 88 
</span><span class="z-text z-plain">05 62 69 54     62     04 0C 37 5A 55     0C B9 9F 21 
</span><span class="z-text z-plain">05 62 69 54     63     01 5F 6D 53 00     7D 55 D6 EC
</span><span class="z-text z-plain">05 62 69 54     64     5A 0C 37 5C 06     F9 FB AA 5E
</span><span class="z-text z-plain">05 62 69 54     65     54 5C 36 5D 00     B7 20 36 7B 
</span><span class="z-text z-plain">05 62 69 54     66     00 58 64 03 07     A6 21 A5 2E 
</span><span class="z-text z-plain">05 62 69 54     67     55 0B 36 51 57     C8 E8 02 80 
</span><span class="z-text z-plain">05 62 69 54     68     06 59 29 C2 C8     0A AF 71 26
</span></code></pre><p>And would you know it, <code>8 * 5 = 40</code> which is exactly the expected flag length. We now know that we're on the right track.<p>More analysis leads to the conclusion that the data is encoded in the following format:<p><code>Chunk size | b | i | T | Index | Chunk1 | Chunk2 | Chunk3 | Chunk 4 | Chunk 5 | Padding / Trash</code><p>The next step is to encode a factice flag and see what the <code>flag{</code> characters encode to. If we try to encore <code>flag{AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA}</code>, we indeed get <code>05 62 69 54 67 55 0B 36 51 57 C8 E8 02 80</code> as our first line.<p>The logical next step is to create a dictionnary in order to decode the flag. We feed the following strings as input to the program and carve out the data:<ul><li><code>flag{abcdefghijklmnopqrstuvwxyzABCDEFGH}</code><li><code>flag{ABCDEFGHIJKLMNOPQRSTUVWXYZ01234567}</code><li><code>flag{89.-/_............................}</code></ul><p>As expected, we observe that the first line never changes. We are nonetheless hitting a wall because there are multiple caracters that encode to the same number. The algorithm hence must not use a simple 1-to-1 conversion mechanism.<p>Through more observation and some static analysis, we found that the first 3 gylphs of the payload are simply xored' with the <code>biT</code> string. Strong with this discovery, and helped by the fast that xor is an easily reversible operation, we get to work on the first line using our crib (<code>flag{</code>) and our ciphertext <code>05 62 69 54 61 04 05 35 06 19 9D C5 69 88</code>.<p>We know that:<ul><li><code>04 05 35</code> is "fla"<li><code>06</code> must be "g"<li><code>19</code> must be "{"</ul><p>What is don't know is how the letters "g" and "{" were encoded. If we tinker and take the ascii values for these letters and xor them with the data in the ciphertext, we get:<ul><li><code>g ^ 0x06 = 0x67 ^ 0x06 = 0x61</code><li><code>{ ^ 0x19 = 0x7B ^ 0x19 = 0x62</code></ul><p>Which happen to be the 5th and 2nd bytes in our line, respectively. We've discovered that for each line, the key is contained within the line itself. For the first line:<ul><li><code>62 69 54 61 62</code> is the XOR key<li><code>04 05 35 06 19</code> is the ciphertext</ul><p>XOR'ing both together indeed gives <code>f l a g {</code>.<p>We now only need to piece together a script to decode the whole ciphertext. The relevant part is the following:<pre class="language-python z-code" data-lang=python><code class=language-python data-lang=python><span class="z-source z-python"><span class="z-meta z-function z-python"><span class="z-storage z-type z-function z-python"><span class="z-keyword z-declaration z-function z-python">def</span></span> <span class="z-entity z-name z-function z-python"><span class="z-meta z-generic-name z-python">xor_decrypt</span></span></span><span class="z-meta z-function z-parameters z-python"><span class="z-punctuation z-section z-parameters z-begin z-python">(</span></span><span class="z-meta z-function z-parameters z-python"><span class="z-variable z-parameter z-python">cipher</span><span class="z-punctuation z-section z-parameters z-end z-python">)</span></span><span class="z-meta z-function z-python"><span class="z-punctuation z-section z-function z-begin z-python">:</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">result</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-sequence z-list z-empty z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span>
</span><span class="z-source z-python">    <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">i</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>61</span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-meta z-statement z-loop z-for z-python"><span class="z-keyword z-control z-loop z-for z-python">for</span> <span class="z-meta z-generic-name z-python">group</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span><span class="z-meta z-statement z-loop z-for z-python"> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">cipher</span></span></span><span class="z-meta z-statement z-loop z-for z-python"><span class="z-punctuation z-section z-block z-loop z-for z-python">:</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">key</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>62</span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>69</span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>54</span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">i</span></span><span class="z-punctuation z-separator z-sequence z-python">,</span> <span class="z-constant z-numeric z-integer z-hexadecimal z-python"><span class="z-punctuation z-definition z-numeric z-base z-python">0x</span>62</span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">xored_bytes</span></span> <span class="z-keyword z-operator z-assignment z-python">=</span> <span class="z-meta z-sequence z-list z-python"><span class="z-punctuation z-section z-sequence z-begin z-python">[</span><span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">group</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">j</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-keyword z-operator z-arithmetic z-python">^</span> <span class="z-meta z-item-access z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">key</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-begin z-python">[</span></span><span class="z-meta z-item-access z-arguments z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">j</span></span></span><span class="z-meta z-item-access z-python"><span class="z-punctuation z-section z-brackets z-end z-python">]</span></span> <span class="z-meta z-expression z-generator z-python"><span class="z-keyword z-control z-loop z-for z-generator z-python">for</span> <span class="z-meta z-generic-name z-python">j</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span> <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">range</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-constant z-numeric z-integer z-decimal z-python">5</span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-sequence z-end z-python">]</span></span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">        <span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">result</span></span><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">append</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">join</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-support z-function z-builtin z-python">chr</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">b</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span> <span class="z-meta z-expression z-generator z-python"><span class="z-keyword z-control z-loop z-for z-generator z-python">for</span> <span class="z-meta z-generic-name z-python">b</span> <span class="z-keyword z-control z-loop z-for z-in z-python">in</span></span> <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">xored_bytes</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span><span class="z-source z-python">        <span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">i</span></span> <span class="z-keyword z-operator z-assignment z-augmented z-python">+=</span> <span class="z-constant z-numeric z-integer z-decimal z-python">1</span>
</span><span class="z-source z-python">
</span><span class="z-source z-python">    <span class="z-keyword z-control z-flow z-return z-python">return</span> <span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-begin z-python">"</span></span></span><span class="z-meta z-string z-python"><span class="z-string z-quoted z-double z-python"><span class="z-punctuation z-definition z-string z-end z-python">"</span></span></span><span class="z-meta z-function-call z-python"><span class="z-meta z-qualified-name z-python"><span class="z-punctuation z-accessor z-dot z-python">.</span></span><span class="z-meta z-qualified-name z-python"><span class="z-variable z-function z-python"><span class="z-meta z-generic-name z-python">join</span></span></span></span><span class="z-meta z-function-call z-arguments z-python"><span class="z-punctuation z-section z-arguments z-begin z-python">(</span><span class="z-meta z-qualified-name z-python"><span class="z-meta z-generic-name z-python">result</span></span><span class="z-punctuation z-section z-arguments z-end z-python">)</span></span>
</span></code></pre><p>Running the script on the data that was carved out of the PNG file indeed gives us the flag: <code>flag{fec87c690b8ec8d65b8bb10ee7bb65d0}</code>.</article></div></main><div class="bg-secondary text-primary-foreground w-fit fixed bottom-4 float-right right-8 transition-all duration-200 opacity-0" title="Scroll to top" id=scroll-to-top><div class="bg-primary h-full absolute -z-10" id=scroll-fill></div><svg class="h-6 w-6 mx-4 md:my-2 my-1 fill-primary-foreground" viewbox="0 0 16 16" xmlns=http://www.w3.org/2000/svg><path d="M3.47 7.78a.75.75 0 0 1 0-1.06l4.25-4.25a.75.75 0 0 1 1.06 0l4.25 4.25a.751.751 0 0 1-.018 1.042.751.751 0 0 1-1.042.018L9 4.81v7.44a.75.75 0 0 1-1.5 0V4.81L4.53 7.78a.75.75 0 0 1-1.06 0Z"></path></svg></div>